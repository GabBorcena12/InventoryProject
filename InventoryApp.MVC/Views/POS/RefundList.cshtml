@model IEnumerable<InventoryApp.Core.Models.PosModels.CreditMemo>

@{
    ViewData["Title"] = "Refund List";

    int currentPage = ViewBag.CurrentPage ?? 1;
    int pageSize = ViewBag.PageSize ?? 10;
    int totalItems = ViewBag.TotalItems ?? 0;
    int totalPages = (int)Math.Ceiling((decimal)totalItems / pageSize);
    string search = ViewBag.Search ?? "";
}

<style>
    .modal-content.width-auto {
        width: auto !important;
    }

    .modal-dialog {
        display: flex;
        justify-content: center; /* center horizontally */
        align-items: center; /* center vertically */
        min-height: 100vh; /* full viewport height */
    }

    .modal-content {
        width: auto; /* shrink to fit content */
        max-width: 600px; /* optional: set a limit */
        margin: auto; /* ensure it's centered */
    }

    .modal-body {
        max-height: 60vh; /* limit height relative to viewport */
        overflow-y: auto; /* allow vertical scroll */
        scrollbar-width: none; /* hide scrollbar in Firefox */
        -ms-overflow-style: none; /* hide scrollbar in IE/Edge */
    }

    .modal-body::-webkit-scrollbar {
        display: none; /* hide scrollbar in Chrome/Safari */
    }

    th {
        text-align: left !important;
    }

</style>
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-1">
        <h2>@ViewData["Title"]</h2>
        <a asp-action="CreateRefund" class="btn btn-success"><i class="bi bi-plus"></i> Process Refund</a>
    </div>
    <p class="text-muted mb-3">
        List of all refunded transactions processed on POS system.
    </p>
    <!-- Search -->
    <form method="get" class="row g-2 mb-3">
        <div class="col-sm-4">
            <input type="text" name="search" value="@search" class="form-control"
                   placeholder="Search by CM # or OR #" />
        </div>
        <div class="col-sm-2">
            <button type="submit" class="btn btn-primary w-100">Search</button>
        </div>
    </form>

    @if (Model != null && Model.Any())
    {
        <table class="table table-bordered table-hover mt-3">
            <thead class="table-dark">
                <tr>
                    <th>CM #</th>
                    <th>OR #</th>
                    <th>Reason</th>
                    <th>Amount</th>
                    <th>Issued At</th>
                    <th>Issued By</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var refund in Model)
                {
                    <tr>
                        <td>@refund.CreditMemoNumber</td>
                        <td>@refund.TransactionOrNumber</td>
                        <td>@refund.Reason</td>
                        <td>@refund.TotalAmount.ToString()</td>
                        <td>@refund.IssuedAt.ToString("yyyy-MM-dd HH:mm")</td>
                        <td>@refund.IssuedBy</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary print-memo"
                                    data-id="@refund.Id"
                                    data-cmno="@refund.CreditMemoNumber"
                                    data-orno="@refund.TransactionOrNumber"
                                    data-sku="@refund.Sku"
                                    data-productname="@refund.ProductName"
                                    data-reason="@refund.Reason"
                                    data-qty="@refund.Qty"
                                    data-amount="@refund.Amount"
                                    data-total="@refund.TotalAmount"
                                    data-issuedat="@refund.IssuedAt.ToString("yyyy-MM-dd HH:mm")"
                                    data-issuedby="@refund.IssuedBy">
                                <i class="bi bi-printer"></i> Print Memo
                            </button>

                            @if (!refund.IsVoided)
                            {
                                <button class="btn btn-sm btn-outline-danger"
                                        data-bs-toggle="modal"
                                        data-bs-target="#voidCreditMemoModal"
                                        data-id="@refund.Id"
                                        data-cmno="@refund.CreditMemoNumber">
                                    <i class="bi bi-x-circle"></i> Void Memo
                                </button>
                            }
                            else
                            {
                                <span class="badge bg-danger"><i class="bi bi-x-circle"></i> Voided</span>
                            }
                        </td>

                    </tr>
                }
            </tbody>
        </table>
        @if (totalPages > 1)
        {
            <nav>
                @{
                    int startPage = Math.Max(1, currentPage - 1);
                    int endPage = Math.Min(totalPages, startPage + 2);

                    if (endPage - startPage < 2)
                    {
                        startPage = Math.Max(1, endPage - 2);
                    }
                }

                <ul class="pagination" style="justify-content:center">
                    <!-- Previous -->
                    @if (currentPage > 1)
                    {
                        <li class="page-item">
                            <a class="page-link" href="?search=@search&page=@(currentPage - 1)&pageSize=@pageSize">Previous</a>
                        </li>
                    }

                    <!-- Page numbers -->
                    @for (int i = startPage; i <= endPage; i++)
                    {
                        <li class="page-item @(i == currentPage ? "active" : "")">
                            <a class="page-link" href="?search=@search&page=@i&pageSize=@pageSize">@i</a>
                        </li>
                    }

                    <!-- Next -->
                    @if (currentPage < totalPages)
                    {
                        <li class="page-item">
                            <a class="page-link" href="?search=@search&page=@(currentPage + 1)&pageSize=@pageSize">Next</a>
                        </li>
                    }
                </ul>
            </nav>
        }
    }
    else
    {
        <div class="alert alert-warning">No records found.</div>
    }
</div>
<!--Void Modal-->
<div class="modal fade" id="voidCreditMemoModal" tabindex="-1" aria-labelledby="voidCreditMemoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form method="post" asp-action="VoidCreditMemoConfirmed" asp-controller="POS">
            @Html.AntiForgeryToken()
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Void Credit Memo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    Are you sure you want to void Credit Memo:
                    <strong id="modalCMNumber"></strong>?
                    <input type="hidden" id="modalCreditMemoId" name="id" />
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Confirm Void</button>
                </div>
            </div>
        </form>
    </div>
</div>


<!-- Credit Memo Modal -->
<div class="modal fade" id="creditMemoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content width-auto p-3">
            <div class="modal-header">
                <h5 class="modal-title">Credit Memo Receipt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="creditMemoContent" style="font-family: Consolas, monospace; font-size:14px; white-space:pre-wrap;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" id="btnReprintMemo" class="btn btn-primary">Reprint Credit Memo</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        $(document).ready(function () {
            $(".print-memo").click(function () {
                const cmNo = $(this).data("cmno");
                const orNo = $(this).data("orno");
                const sku = $(this).data("sku");
                const productname = $(this).data("productname");
                const reason = $(this).data("reason");
                const qty = $(this).data("qty");
                const amount = parseFloat($(this).data("amount"));
                const total = parseFloat($(this).data("total"));
                const issuedAt = $(this).data("issuedat");
                const issuedBy = $(this).data("issuedby");

                // Format memo text
                const memoText = formatCreditMemo({
                    cmNo, orNo, sku, productname, reason, qty, amount, total, issuedAt, issuedBy
                });

                $("#creditMemoContent").text(memoText);
                $("#creditMemoModal").modal("show");
            });

            // Reprint button
            $("#btnReprintMemo").click(function () {
                const memoText = $("#creditMemoContent").text();
                const printWindow = window.open('', '', 'height=600,width=400');
                printWindow.document.write('<pre style="font-family: Consolas, monospace; font-size:14px;">' + memoText + '</pre>');
                printWindow.document.close();
                printWindow.print();
            });

            // Formatter
            function formatCreditMemo(memo, options = {}) {
                const {
                    businessName = "Anjey's Pet Supplies",
                    businessAddress = "BLK 16, San Jose Del Monte Heights, Muzon East",
                    tin = "123-456-789-000",
                    footer = "Thank you! This serves as your credit memo."
                } = options;

                const pad = (text = "", width = 50, align = "left") => {
                    if (text.length >= width) return text.slice(0, width);
                    if (align === "right") return text.padStart(width);
                    if (align === "center") return text.padStart(Math.floor((width + text.length) / 2)).padEnd(width);
                    return text.padEnd(width);
                };

                const lines = [];
                lines.push(pad("CREDIT MEMO", 50, "center"));
                lines.push(pad(businessName.toUpperCase(), 50, "center"));
                lines.push(pad(businessAddress, 50, "center"));
                lines.push(pad(`TIN: ${tin}`, 50, "center"));
                lines.push("-".repeat(50));
                lines.push(pad(`CM#: ${memo.cmNo}`, 50));
                lines.push(pad(`OR#: ${memo.orNo}`, 50));
                lines.push(pad(`Issued: ${memo.issuedAt}`, 50));
                lines.push(pad(`Issued By: ${memo.issuedBy}`, 50));
                lines.push("-".repeat(50));
                lines.push(`Reason: ${memo.reason}`);
                lines.push("-".repeat(50));
                lines.push(`Sku: ${memo.sku}`);
                lines.push(`Product: ${memo.productname}`);
                lines.push(`Qty: ${memo.qty}`);
                lines.push(`Unit Price: ₱${memo.amount.toFixed(2)}`);
                lines.push(`Total: ₱${memo.total.toFixed(2)}`);
                lines.push("-".repeat(50));
                lines.push(pad(footer, 50, "center"));
                return lines.join("\n");
            }

            $('#voidCreditMemoModal').on('show.bs.modal', function (event) {
                const button = $(event.relatedTarget);
                const cmId = button.data('id');
                const cmNo = button.data('cmno');

                $('#modalCreditMemoId').val(cmId);
                $('#modalCMNumber').text(cmNo);
            });
        });
    </script>
}

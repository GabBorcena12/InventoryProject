@model List<InventoryApp.Core.Models.RepackItem>

@{
    ViewData["Title"] = "Stock Items";
    var currentPage = (int)(ViewBag.CurrentPage ?? 1);
    var totalPages = (int)(ViewBag.TotalPages ?? 1);
}

<div class="container mt-4">
    @{
        var repackTotalWeight = Model.Sum(item => item.InitialQty * item.QuantityValue);
        var inventoryTotalWeight = ViewBag.InventoryTotalWeight ?? 0;
        bool isDisabled = repackTotalWeight >= Convert.ToDecimal(inventoryTotalWeight);
    }

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>@ViewData["Title"]</h2>
        @if (isDisabled)
        {
            <a class="btn btn-success disabled" tabindex="-1" aria-disabled="true"><i class="bi bi-plus"></i>Add Stock</a>
        }
        else
        {
            <a asp-action="CreateStock" asp-route-id="@ViewBag.InventoryId" class="btn btn-success"><i class="bi bi-plus"></i>Add Stock</a>
        }
    </div>

    @if (Model != null && Model.Any())
    {
        <table class="table table-bordered table-striped table-hover align-middle">
            <thead>
                <tr>
                    <th rowspan="2" class="align-middle">Stock Variant</th>
                    <th colspan="4" class="text-center">Quantity</th>
                    <th colspan="1" class="text-center">Amount</th>
                    <th rowspan="5" class="align-middle">Actions</th>
                </tr>
                <tr>
                    <th>Initial Stock</th>
                    <th>On Display</th>
                    <th>Sold / Released</th>
                    <th>Available</th>
                    <th>Retail Price</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    var availableQty = item.InitialQty - item.SoldQty;
                    var unit = item.product?.UnitOfMeasure != null ? item.product.UnitOfMeasure.ToString() : "";
                    var qty = item.QuantityValue;
                    var pluralSuffix = (qty > 1 && !string.IsNullOrEmpty(unit) && !unit.EndsWith("s", StringComparison.OrdinalIgnoreCase)) ? "s" : "";

                    <tr>
                        <td>@item.VariantCode</td>

                        <td>@item.InitialQty Piece@((item.InitialQty > 1) ? "s" : "")</td>
                        <td>@item.QuantityDisplayed Piece@((item.QuantityDisplayed > 1) ? "s" : "")</td>
                        <td>@item.SoldQty Piece@((item.SoldQty > 1) ? "s" : "")</td>
                        <td>@availableQty Piece@((availableQty > 1) ? "s" : "")</td>

                        <td>@item.PricePerUnit.ToString("N2")</td>
                        <td>
                            <div class="d-flex flex-wrap gap-1">
                                <a asp-action="ViewStock" asp-route-id="@item.Id" class="btn btn-sm btn-outline-secondary">
                                    <i class="bi bi-eye"></i> View Details
                                </a>

                                @if (availableQty > 0)
                                {
                                    @if (item.QuantityDisplayed < availableQty)
                                    {
                                        <button type="button" class="btn btn-sm btn-outline-primary mark-display-btn"
                                                data-id="@item.Id"
                                                data-name="@item.VariantCode">
                                            <i class="bi bi-box-arrow-up"></i> Release Item
                                        </button>

                                        <button type="button"
                                                class="btn btn-sm btn-outline-success add-to-pos-btn"
                                                data-id="@item.Id"
                                                data-name="@item.VariantCode">
                                            <i class="bi bi-cart-plus"></i> Add to POS
                                        </button>
                                    }
                                    else
                                    {
                                        <button type="button" class="btn btn-sm btn-outline-secondary" disabled
                                                title="All available units are already displayed.">
                                            <i class="bi bi-check-circle"></i> Stock Added
                                        </button>
                                    }
                                }

                                @if (item.SoldQty == 0 && item.QuantityDisplayed == 0)
                                {
                                    <button type="button" class="btn btn-sm btn-outline-danger delete-btn"
                                            data-id="@item.Id"
                                            data-name="@item.VariantCode"
                                            data-weight="@item.QuantityValue">
                                        <i class="bi bi-trash"></i> Delete Stock
                                    </button>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
            <tfoot class="table-light fw-bold">
                <tr>
                    <td class="text-end">Subtotal:</td>
                    <td>@Model.Sum(x => x.InitialQty) Piece@((Model.Sum(x => x.InitialQty) > 1) ? "s" : "")</td>
                    <td>@Model.Sum(x => x.QuantityDisplayed) Piece@((Model.Sum(x => x.QuantityDisplayed) > 1) ? "s" : "")</td>
                    <td>@Model.Sum(x => x.SoldQty) Piece@((Model.Sum(x => x.SoldQty) > 1) ? "s" : "")</td>
                    <td>@Model.Sum(x => x.InitialQty - x.SoldQty) Piece@((Model.Sum(x => x.InitialQty - x.SoldQty) > 1) ? "s" : "")</td>
                    <td></td>
                    @* <td>@Model.Sum(x => x.TotalSales).ToString("N2")</td> *@
                    <td></td>
                </tr>
            </tfoot>
        </table>
    }
    else
    {
        <div class="alert alert-warning mt-3">No records found.</div>
    }
</div>
<!-- Pagination -->
<nav>
    <ul class="pagination justify-content-center">
        @for (int i = 1; i <= totalPages; i++)
        {
            var isActive = i == currentPage;

            <li class="page-item @(isActive ? "active" : "")">
                <a class="page-link @(isActive ? "bg-success text-white border-success" : "bg-white text-success border-success")"
                   href="@Url.Action("Repack", new { id = ViewBag.InventoryId, page = i })">
                    @i
                </a>
            </li>
        }
    </ul>
</nav>


<!-- Hidden delete form -->
<form id="deleteForm" method="post" asp-action="DeleteRepackConfirmed">
    <input type="hidden" name="id" id="deleteId" />
</form>

<!-- Hidden mark as sold form -->
<form id="markSoldForm" method="post" asp-action="MarkAsSold">
    <input type="hidden" name="id" id="soldId" />
</form>

<!-- Delete Confirmation Toast -->
<div class="modal fade" id="confirmToast" tabindex="-1" aria-labelledby="confirmToastLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="confirmToastLabel">Delete Stock</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                Are you sure you want to delete <strong id="toastItemName"></strong>?
                <input type="hidden" name="id" id="deleteId" />
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-danger" id="confirmDeleteBtn">Confirm Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Sold Confirmation Modal -->
<div class="modal fade" id="soldModal" tabindex="-1" aria-labelledby="soldModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="soldModalLabel">Confirm Sale</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to sold <strong id="soldItemName"></strong> ?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmSoldBtn">Sell</button>
            </div>
        </div>
    </div>
</div>

<!-- Display Confirmation Modal -->
<div class="modal fade" id="displayModal" tabindex="-1" aria-labelledby="displayModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form method="post" id="markDisplayForm" asp-action="MarkAsDisplayed">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="displayModalLabel">Release Item</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="id" id="displayId" />
                    <div class="mb-3">
                        <label for="displayQty" class="form-label">No. of item/s to release:</label>
                        <input type="number" class="form-control" name="quantityToRelease" id="displayQty" min="1" required />
                    </div>
                    <div class="mb-3">
                        <label for="reason" class="form-label">Reason</label>
                        <input type="text" class="form-control" name="reason" maxlength="30" id="reason" required placeholder="e.g. Item expired." />
                    </div>
                    <div id="displayItemName" class="fw-bold text-center"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Confirm Display</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Add To POS Confirmation Modal -->
<div class="modal fade" id="addToPosModal" tabindex="-1" aria-labelledby="addToPosModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form method="post" id="addToPosForm" asp-controller="POS" asp-action="AddToPosItems">
            @Html.AntiForgeryToken()
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="addToPosModalLabel">Add to POS</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Hidden field for item id -->
                    <input type="hidden" name="id" id="posItemId" />

                    <!-- Quantity input -->
                    <div class="mb-3">
                        <label for="posQty" class="form-label">No. of item/s to add to POS: </label>
                        <input type="number" class="form-control" name="quantityToDisplay" id="posQty" min="1" required />
                    </div>

                    <!-- Display product name -->
                    <div id="posItemName" class="fw-bold text-center"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Confirm Add</button>
                </div>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let deleteId = 0;
        let soldId = 0;
        let displayId = 0;

        $(document).ready(function () {
            // Delete flow
            $('.delete-btn').click(function () {
                deleteId = $(this).data('id');
                const name = $(this).data('name');
                const weight = $(this).data('weight');

                $('#toastItemName').text(name);

                const modal = new bootstrap.Modal(document.getElementById('confirmToast'));
                modal.show();
            });

            $('#confirmDeleteBtn').click(function () {
                $('#deleteId').val(deleteId);
                $('#deleteForm').submit();
            });


            // Mark as Sold flow
            $('.mark-sold-btn').click(function () {
                soldId = $(this).data('id');
                const name = $(this).data('name');
                $('#soldItemName').text(name);
                const modal = new bootstrap.Modal(document.getElementById('soldModal'));
                modal.show();
            });

            $('#confirmSoldBtn').click(function () {
                $('#soldId').val(soldId);
                $('#markSoldForm').submit();
            });

            // Mark as Display flow
            $('.mark-display-btn').click(function () {
                displayId = $(this).data('id');
                const name = $(this).data('name');
                $('#displayId').val(displayId);
                $('#displayItemName').text(name);
                $('#displayQty').val(1);
                const modal = new bootstrap.Modal(document.getElementById('displayModal'));
                modal.show();
            });

            // Add to POS flow
            $('.add-to-pos-btn').click(function () {
                posId = $(this).data('id');
                const name = $(this).data('name');

                $('#posItemId').val(posId);
                $('#posItemName').text(name);
                $('#posQty').val(1);

                const modal = new bootstrap.Modal(document.getElementById('addToPosModal'));
                modal.show();
            });
        });
    </script>

}

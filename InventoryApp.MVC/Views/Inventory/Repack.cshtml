@model List<InventoryApp.Core.Models.RepackItem>
@{
    ViewData["Title"] = "Ready Items";
}

<div class="container mt-4">
    @{
        var repackTotalWeight = Model.Sum(item => (item.InitialQty) * item.QuantityValue);
        var inventoryTotalWeight = ViewBag.InventoryTotalWeight;
        bool isDisabled = repackTotalWeight >= inventoryTotalWeight;
    }

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Ready Items</h2>
        @if (isDisabled)
        {
            <a class="btn btn-success disabled" tabindex="-1" aria-disabled="true">Add Stock</a>
        }
        else
        {
            <a asp-action="CreateRepack" asp-route-id="@ViewBag.InventoryId" class="btn btn-success">Add Stock</a>
        }
    </div>


    @await Html.PartialAsync("_ToastMessages")
    @await Html.PartialAsync("_ErrorMessage")

    @if (Model != null && Model.Any())
    {
        <table class="table table-bordered table-striped table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th rowspan="2" class="align-middle">Inventory</th>
                    <th rowspan="2" class="align-middle">Volume</th>
                    <th colspan="4" class="text-center">Quantity</th>
                    <th colspan="3" class="text-center">Amount</th>
                    <th rowspan="2" class="align-middle">Actions</th>
                </tr>
                <tr>
                    <th>Initial</th>
                    <th>Displayed</th>
                    <th>Sold</th>
                    <th>Available</th>
                    <th>Price</th>
                    <th>Disc</th>
                    <th>Sales</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    var availableQty = item.InitialQty - item.SoldQty;
                    <tr>
                        <td>@item.ProductName</td>
                        <td>
                            @{
                                var unit = item.product?.UnitOfMeasure.ToString();
                                var qty = item.QuantityValue;
                                var pluralSuffix = (qty > 1 && unit != null && !unit.EndsWith("s", StringComparison.OrdinalIgnoreCase)) ? "s" : "";
                            }

                            @item.QuantityValue @unit@pluralSuffix
                        </td>

                        <td>
                            @item.InitialQty Piece@((item.InitialQty > 1) ? "s" : "")
                        </td>
                        <td>
                            @item.QuantityDisplayed Piece@((item.QuantityDisplayed > 1) ? "s" : "")
                        </td>
                        <td>
                            @item.SoldQty Piece@((item.SoldQty > 1) ? "s" : "")
                        </td>
                        <td>
                            @availableQty Piece@((availableQty > 1) ? "s" : "")
                        </td>

                        <td>@item.PricePerUnit.ToString("N2")</td>
                        <td>@item.Discount.ToString("P1")</td>
                        <td>@item.TotalSales.ToString("N2")</td>
                        <td>
                            <a asp-action="ViewRepack" asp-route-id="@item.Id" class="btn btn-sm btn-info me-1 text-white">View Details</a>
                            @if (availableQty > 0)
                            {
                                <div class="mt-2">
                                    
                                    @if (item.QuantityDisplayed < availableQty)
                                    {
                                        <button type="button" class="btn btn-sm btn-success me-1 mark-display-btn"
                                                data-id="@item.Id"
                                                data-name="@item.ProductName">
                                            Display Item
                                        </button>
                                    }
                                    else
                                    {
                                        <button type="button" class="btn btn-sm btn-secondary me-1" disabled
                                                title="All available units are already displayed.">
                                            Displayed
                                        </button>
                                    }
                                </div>
                            }
                            @if (item.SoldQty == 0 && item.QuantityDisplayed == 0)
                            {
                                <button type="button" class="btn btn-sm btn-danger delete-btn"
                                        data-id="@item.Id"
                                        data-name="@item.ProductName"
                                        data-weight="@item.QuantityValue">
                                    Delete
                                </button>
                            }
                        </td>
                    </tr>
                }
            </tbody>
            <tfoot class="table-light fw-semibold">
                <tr>
                    <td colspan="1" class="text-end">Subtotal:</td>
                    <td>
                        @{
                            var totalWeight = Model.Sum(item => (item.InitialQty) * item.QuantityValue);
                        }
                        @totalWeight
                    </td>
                    <td>
                        @{
                            var init = Model.Sum(x => x.InitialQty);
                        }
                        @init Piece@((init > 1) ? "s" : "")
                    </td>
                    <td>
                        @{
                            var disp = Model.Sum(x => x.QuantityDisplayed);
                        }
                        @disp Piece@((disp > 1) ? "s" : "")
                    </td>
                    <td>
                        @{
                            var sold = Model.Sum(x => x.SoldQty);
                        }
                        @sold Piece@((sold > 1) ? "s" : "")
                    </td>
                    <td>
                        @{
                            var avail = Model.Sum(x => x.InitialQty - x.SoldQty);
                        }
                        @avail Piece@((avail > 1) ? "s" : "")
                    </td>
                    <td></td>
                    <td></td>
                    <td>@Model.Sum(x => x.TotalSales).ToString("N2")</td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
        @if (ViewBag.TotalPages > 1)
        {
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center mt-4">
                    @for (int i = 1; i <= (int)ViewBag.TotalPages; i++)
                    {
                        var active = (i == (int)ViewBag.CurrentPage) ? "active" : "";
                        <li class="page-item @active">
                            <a class="page-link" asp-action="Repack" asp-route-id="@ViewBag.InventoryId" asp-route-page="@i">@i</a>
                        </li>
                    }
                </ul>
            </nav>
        }

    }
    else
    {
        <div class="alert alert-warning mt-3">No records found.</div>
    }
</div>

<!-- Hidden delete form -->
<form id="deleteForm" method="post" asp-action="DeleteRepackConfirmed">
    <input type="hidden" name="id" id="deleteId" />
</form>

<!-- Hidden mark as sold form -->
<form id="markSoldForm" method="post" asp-action="MarkAsSold">
    <input type="hidden" name="id" id="soldId" />
</form>

<!-- Delete Confirmation Toast -->
<div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 1080;">
    <div id="confirmToast" class="toast bg-warning text-dark" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-body m-1">
            Are you sure you want to delete <strong id="toastItemName"></strong>?
        </div>
        <div class="d-flex justify-content-center mt-2 mb-2">
            <button type="button" class="btn btn-sm btn-danger me-2" id="confirmDeleteBtn">Yes</button>
            <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="toast">Cancel</button>
        </div>
    </div>
</div>

<!-- Sold Confirmation Modal -->
<div class="modal fade" id="soldModal" tabindex="-1" aria-labelledby="soldModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="soldModalLabel">Confirm Sale</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to sold <strong id="soldItemName"></strong> ?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmSoldBtn">Sell</button>
            </div>
        </div>
    </div>
</div>

<!-- Display Confirmation Modal -->
<div class="modal fade" id="displayModal" tabindex="-1" aria-labelledby="displayModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form method="post" id="markDisplayForm" asp-action="MarkAsDisplayed">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="displayModalLabel">Display Item</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="id" id="displayId" />
                    <div class="mb-3">
                        <label for="displayQty" class="form-label">Enter quantity to display:</label>
                        <input type="number" class="form-control" name="quantityToDisplay" id="displayQty" min="1" required />
                    </div>
                    <div id="displayItemName" class="fw-bold text-center"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Confirm Display</button>
                </div>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let deleteId = 0;
        let soldId = 0;
        let displayId = 0;

        $(document).ready(function () {
            // Delete flow
            $('.delete-btn').click(function () {
                deleteId = $(this).data('id');
                const name = $(this).data('name');
                const weight = $(this).data('weight');

                $('#toastItemName').text(name + " (" + weight + ")");
                const toastEl = new bootstrap.Toast(document.getElementById('confirmToast'));
                toastEl.show();
            });

            $('#confirmDeleteBtn').click(function () {
                $('#deleteId').val(deleteId);
                $('#deleteForm').submit();
            });

            // Mark as Sold flow
            $('.mark-sold-btn').click(function () {
                soldId = $(this).data('id');
                const name = $(this).data('name');
                $('#soldItemName').text(name);
                const modal = new bootstrap.Modal(document.getElementById('soldModal'));
                modal.show();
            });

            $('#confirmSoldBtn').click(function () {
                $('#soldId').val(soldId);
                $('#markSoldForm').submit();
            });

            // Mark as Display flow
            $('.mark-display-btn').click(function () {
                displayId = $(this).data('id');
                const name = $(this).data('name');
                $('#displayId').val(displayId);
                $('#displayItemName').text(name);
                $('#displayQty').val(1);
                const modal = new bootstrap.Modal(document.getElementById('displayModal'));
                modal.show();
            });

            // Optional: Add form validation for display quantity here
        });
    </script>
}

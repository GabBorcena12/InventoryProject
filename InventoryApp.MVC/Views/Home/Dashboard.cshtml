@using System.Text.Json
@{
    ViewData["Title"] = "Analytics Dashboard";

    var topPerKg = ViewBag.TopPerKg as Dictionary<string, double>;
    var monthlySales = ViewBag.MonthlySales as Dictionary<string, int>;
    var noStock = ViewBag.NoStock as IEnumerable<dynamic>;
    var slowMoving = ViewBag.SlowMoving as List<KeyValuePair<string, double>>;
}

<!-- Bootstrap & Chart.js -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />

<style>
    body {
        font-family: 'Inter', sans-serif;
        background-color: #f8f9fa;
    }

    .dashboard-title {
        font-weight: 600;
        font-size: 2rem;
    }

    .card-body-custom {
        background-color: #2A4759;
        color: #ffffff;
        border-radius: 1rem;
        padding: 2rem;
        height: 100%;
    }

    .chart-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1rem;
    }

    canvas {
        max-height: 300px;
    }
</style>

<!-- JS Variables from Server -->
<script>
    const topPerKgLabels = @Html.Raw(JsonSerializer.Serialize(topPerKg.Keys));
    const topPerKgData = @Html.Raw(JsonSerializer.Serialize(topPerKg.Values));

    const monthlyLabels = @Html.Raw(JsonSerializer.Serialize(monthlySales.Keys));
    const monthlyData = @Html.Raw(JsonSerializer.Serialize(monthlySales.Values));

    const noStockLabels = @Html.Raw(JsonSerializer.Serialize(noStock?.Select(n => n.ProductName)));
    const noStockValues = @Html.Raw(JsonSerializer.Serialize(noStock?.Select(n => n.DisplayStock)));

    const slowMovingLabels = @Html.Raw(JsonSerializer.Serialize(slowMoving?.Select(i => i.Key)));
    const slowMovingValues = @Html.Raw(JsonSerializer.Serialize(slowMoving?.Select(i => i.Value)));
</script>

<div class="container py-4">
    <h2 class="dashboard-title mb-5">@ViewData["Title"]</h2>

    <div class="row row-cols-1 row-cols-md-2 g-4">
        <!-- Top Inventory -->
        <div class="col">
            <div class="shadow-lg rounded-3">
                <div class="card-body card-body-custom">
                    <h5 class="chart-title">Top Inventory by Sales (kg)</h5>
                    <canvas id="topPerKgChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Monthly Sales -->
        <div class="col">
            <div class="shadow-lg rounded-3">
                <div class="card-body card-body-custom">
                    <h5 class="chart-title">Monthly Sales</h5>
                    <canvas id="monthlySalesChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Low Stock Inventory -->
        <div class="col">
            <div class="shadow-lg rounded-3">
                <div class="card-body card-body-custom">
                    <h5 class="chart-title">Low Stock Inventory</h5>
                    <canvas id="lowStockChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Slow Moving Items -->
        <div class="col">
            <div class="shadow-lg rounded-3">
                <div class="card-body card-body-custom">
                    <h5 class="chart-title">Slow Moving Items (&lt; 20kg)</h5>
                    <canvas id="slowMovingChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const barColors = [
        "#4e73df", "#1cc88a", "#36b9cc", "#f6c23e", "#e74a3b", "#858796", "#5a5c69", "#00a6fb", "#7fdbda"
    ];

    // Top Inventory Chart
    new Chart(document.getElementById("topPerKgChart"), {
        type: "bar",
        data: {
            labels: topPerKgLabels,
            datasets: [{
                label: "Kg Sold",
                data: topPerKgData,
                backgroundColor: barColors,
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: "#ffffff" },
                    grid: { color: "#ffffff33" }
                },
                x: {
                    ticks: { color: "#ffffff" },
                    grid: { color: "#ffffff33" }
                }
            }
        }
    });

    // Monthly Sales Chart
    new Chart(document.getElementById("monthlySalesChart"), {
        type: "bar",
        data: {
            labels: monthlyLabels,
            datasets: [{
                label: "Sales",
                data: monthlyData,
                backgroundColor: "#4e73df"
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: "#ffffff" },
                    grid: { color: "#ffffff33" }
                },
                x: {
                    ticks: { color: "#ffffff" },
                    grid: { color: "#ffffff33" }
                }
            }
        }
    });

    // Low Stock - Doughnut Chart
    if (noStockLabels?.length > 0) {
        new Chart(document.getElementById("lowStockChart"), {
            type: "doughnut",
            data: {
                labels: noStockLabels,
                datasets: [{
                    label: "Available Stock",
                    data: noStockValues,
                    backgroundColor: barColors
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: "#ffffff" }
                    }
                }
            }
        });
    }

    // Slow Moving Items - Horizontal Bar Chart
    if (slowMovingLabels?.length > 0) {
        new Chart(document.getElementById("slowMovingChart"), {
            type: "bar",
            data: {
                labels: slowMovingLabels,
                datasets: [{
                    label: "Qty Sold (kg)",
                    data: slowMovingValues,
                    backgroundColor: "#f6c23e"
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: { color: "#ffffff" },
                        grid: { color: "#ffffff33" }
                    },
                    y: {
                        ticks: { color: "#ffffff" },
                        grid: { color: "#ffffff33" }
                    }
                }
            }
        });
    }
</script>

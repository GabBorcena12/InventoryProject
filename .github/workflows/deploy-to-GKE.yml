name: â˜ï¸ CI/CD to GKE with GHCR

on:
  push:
    branches:
      - master

env:
  GHCR_REGISTRY: ghcr.io/gabborcena12

jobs:
  deploy-to-gke:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ†” Set Docker image tag
        run: |
          sha="${GITHUB_SHA::7}"
          echo "IMAGE_TAG=$sha" >> $GITHUB_ENV

      - name: ğŸ” Login to GHCR
        run: echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ secrets.GHCR_USERNAME }}" --password-stdin

      - name: ğŸ³ Build & Push InventoryApp.MVC image
        run: |
          docker build --no-cache -t "$GHCR_REGISTRY/inventoryapp-mvc:$IMAGE_TAG" -f InventoryApp.MVC/Dockerfile .
          docker tag "$GHCR_REGISTRY/inventoryapp-mvc:$IMAGE_TAG" "$GHCR_REGISTRY/inventoryapp-mvc:latest"
          docker push "$GHCR_REGISTRY/inventoryapp-mvc:$IMAGE_TAG"
          docker push "$GHCR_REGISTRY/inventoryapp-mvc:latest"

      - name: ğŸ³ Build & Push InventoryApi image
        run: |
          docker build --no-cache -t "$GHCR_REGISTRY/inventoryapi:$IMAGE_TAG" -f Inventory.Api/Dockerfile .
          docker tag "$GHCR_REGISTRY/inventoryapi:$IMAGE_TAG" "$GHCR_REGISTRY/inventoryapi:latest"
          docker push "$GHCR_REGISTRY/inventoryapi:$IMAGE_TAG"
          docker push "$GHCR_REGISTRY/inventoryapi:latest"

      - name: ğŸ” Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: â˜ï¸ Set up GKE credentials
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER_NAME }}
          location: ${{ secrets.GKE_REGION }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: ğŸ›¡ï¸ Create image pull secret in GKE (ghcr-secret)
        run: |
          kubectl delete secret ghcr-secret --ignore-not-found
          kubectl create secret docker-registry ghcr-secret \
            --docker-server=https://ghcr.io \
            --docker-username=${{ secrets.GHCR_USERNAME }} \
            --docker-password=${{ secrets.GHCR_PAT }} \
            --docker-email=gabrielborcena12@gmail.com

      - name: ğŸ”§ Update image tags in GKE manifests
        run: |
          sed -i "s|ghcr.io/gabborcena12/inventoryapp-mvc:__IMAGE_TAG__|$GHCR_REGISTRY/inventoryapp-mvc:$IMAGE_TAG|g" k8s/deployments/inventoryapp-deployment.yaml
          sed -i "s|ghcr.io/gabborcena12/inventoryapi:__IMAGE_TAG__|$GHCR_REGISTRY/inventoryapi:$IMAGE_TAG|g" k8s/deployments/inventoryapi-deployment.yaml

      - name: ğŸ” Apply MSSQL secret
        run: kubectl apply -f k8s/secrets/mssql-secret.yaml

      - name: ğŸ—„ï¸ Create MSSQL PersistentVolumeClaim
        run: kubectl apply -f k8s/persistentvolumeclaims/mssql-pvc.yaml

      - name: ğŸ“¦ Deploy updated manifests
        run: |
          kubectl apply -f k8s/deployments/mssql-deployment.yaml
          kubectl apply -f k8s/services/mssql-service.yaml
          kubectl apply -f k8s/deployments/inventoryapp-deployment.yaml
          kubectl apply -f k8s/services/inventoryapp-service.yaml
          kubectl apply -f k8s/deployments/inventoryapi-deployment.yaml
          kubectl apply -f k8s/services/inventoryapi-service.yaml

      - name: ğŸ” Restart deployments
        run: |
          kubectl rollout restart deployment/inventoryapp
          kubectl rollout restart deployment/inventoryapi

      - name: âœ… Confirm rollout status
        run: |
          kubectl rollout status deployment/inventoryapp
          kubectl rollout status deployment/inventoryapi
